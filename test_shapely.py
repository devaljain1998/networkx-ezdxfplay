import shapely
import json
import pprint
# from test_clean_wall_lines import centre_lines, msp, dwg

centre_lines = [{'end_point': (332.5, 823.0),
                 'number': 1,
                 'screen_end_point': (332.5, 823.0),
                 'screen_start_point': (332.5, 823.0),
                 'start_point': (332.5, 546.0),
                 'width': 9.0},
                {'end_point': (332.5, 948.0),
                 'number': 2,
                 'screen_end_point': (332.5, 948.0),
                 'screen_start_point': (332.5, 948.0),
                 'start_point': (332.5, 828.0),
                 'width': 9.0},
                {'end_point': (332.5, 948.0),
                 'number': 3,
                 'screen_end_point': (332.5, 948.0),
                 'screen_start_point': (332.5, 948.0),
                 'start_point': (332.5, 972.0),
                 'width': 9.0},
                {'end_point': (484.5, 876.0),
                 'number': 4,
                 'screen_end_point': (484.5, 876.0),
                 'screen_start_point': (484.5, 876.0),
                 'start_point': (484.5, 981.0),
                 'width': 5.0},
                {'end_point': (556.5, 876.0),
                 'number': 5,
                 'screen_end_point': (556.5, 876.0),
                 'screen_start_point': (556.5, 876.0),
                 'start_point': (556.5, 823.0),
                 'width': 5.0},
                {'end_point': (556.5, 972.0),
                 'number': 6,
                 'screen_end_point': (556.5, 972.0),
                 'screen_start_point': (556.5, 972.0),
                 'start_point': (556.5, 880.0),
                 'width': 5.0},
                {'end_point': (616.5, 450.0),
                 'number': 7,
                 'screen_end_point': (616.5, 450.0),
                 'screen_start_point': (616.5, 450.0),
                 'start_point': (616.5, 537.0),
                 'width': 5.0},
                {'end_point': (616.5, 645.0),
                 'number': 8,
                 'screen_end_point': (616.5, 645.0),
                 'screen_start_point': (616.5, 645.0),
                 'start_point': (616.5, 546.0),
                 'width': 5.0},
                {'end_point': (644.0, 399.0),
                 'number': 9,
                 'screen_end_point': (644.0, 399.0),
                 'screen_start_point': (644.0, 399.0),
                 'start_point': (644.0, 441.0),
                 'width': 4.0},
                {'end_point': (646.5, 399.0),
                 'number': 10,
                 'screen_end_point': (646.5, 399.0),
                 'screen_start_point': (646.5, 399.0),
                 'start_point': (646.5, 390.0),
                 'width': 9.0},
                {'end_point': (648.5, 399.0),
                 'number': 11,
                 'screen_end_point': (648.5, 399.0),
                 'screen_start_point': (648.5, 399.0),
                 'start_point': (648.5, 399.0),
                 'width': 5.0},
                {'end_point': (667.5, 645.0),
                 'number': 12,
                 'screen_end_point': (667.5, 645.0),
                 'screen_start_point': (667.5, 645.0),
                 'start_point': (667.5, 645.0),
                 'width': 13.0},
                {'end_point': (670.0, 645.0),
                 'number': 13,
                 'screen_end_point': (670.0, 645.0),
                 'screen_start_point': (670.0, 645.0),
                 'start_point': (670.0, 640.0),
                 'width': 18.0},
                {'end_point': (676.5, 718.0),
                 'number': 14,
                 'screen_end_point': (676.5, 718.0),
                 'screen_start_point': (676.5, 718.0),
                 'start_point': (676.5, 645.0),
                 'width': 5.0},
                {'end_point': (705.0, 823.0),
                 'number': 15,
                 'screen_end_point': (705.0, 823.0),
                 'screen_start_point': (705.0, 823.0),
                 'start_point': (705.0, 781.0),
                 'width': 4.0},
                {'end_point': (704.5, 912.0),
                 'number': 16,
                 'screen_end_point': (704.5, 912.0),
                 'screen_start_point': (704.5, 912.0),
                 'start_point': (704.5, 912.0),
                 'width': 3.0},
                {'end_point': (705.0, 912.0),
                 'number': 17,
                 'screen_end_point': (705.0, 912.0),
                 'screen_start_point': (705.0, 912.0),
                 'start_point': (705.0, 828.0),
                 'width': 4.0},
                {'end_point': (704.5, 939.0),
                 'number': 18,
                 'screen_end_point': (704.5, 939.0),
                 'screen_start_point': (704.5, 939.0),
                 'start_point': (704.5, 912.0),
                 'width': 3.0},
                {'end_point': (705.0, 912.0),
                 'number': 19,
                 'screen_end_point': (705.0, 912.0),
                 'screen_start_point': (705.0, 912.0),
                 'start_point': (705.0, 912.0),
                 'width': 4.0},
                {'end_point': (706.5, 912.0),
                 'number': 20,
                 'screen_end_point': (706.5, 912.0),
                 'screen_start_point': (706.5, 912.0),
                 'start_point': (706.5, 912.0),
                 'width': 1.0},
                {'end_point': (748.5, 741.0),
                 'number': 21,
                 'screen_end_point': (748.5, 741.0),
                 'screen_start_point': (748.5, 741.0),
                 'start_point': (748.5, 723.0),
                 'width': 5.0},
                {'end_point': (750.0, 723.0),
                 'number': 22,
                 'screen_end_point': (750.0, 723.0),
                 'screen_start_point': (750.0, 723.0),
                 'start_point': (750.0, 723.0),
                 'width': 8.0},
                {'end_point': (748.5, 777.0),
                 'number': 23,
                 'screen_end_point': (748.5, 777.0),
                 'screen_start_point': (748.5, 777.0),
                 'start_point': (748.5, 764.0),
                 'width': 5.0},
                {'end_point': (750.0, 777.0),
                 'number': 24,
                 'screen_end_point': (750.0, 777.0),
                 'screen_start_point': (750.0, 777.0),
                 'start_point': (750.0, 777.0),
                 'width': 8.0},
                {'end_point': (752.5, 723.0),
                 'number': 25,
                 'screen_end_point': (752.5, 723.0),
                 'screen_start_point': (752.5, 723.0),
                 'start_point': (752.5, 723.0),
                 'width': 3.0},
                {'end_point': (752.5, 777.0),
                 'number': 26,
                 'screen_end_point': (752.5, 777.0),
                 'screen_start_point': (752.5, 777.0),
                 'start_point': (752.5, 777.0),
                 'width': 3.0},
                {'end_point': (763.0, 723.0),
                 'number': 27,
                 'screen_end_point': (763.0, 723.0),
                 'screen_start_point': (763.0, 723.0),
                 'start_point': (763.0, 718.0),
                 'width': 18.0},
                {'end_point': (763.0, 777.0),
                 'number': 28,
                 'screen_end_point': (763.0, 777.0),
                 'screen_start_point': (763.0, 777.0),
                 'start_point': (763.0, 781.0),
                 'width': 18.0},
                {'end_point': (772.5, 399.0),
                 'number': 29,
                 'screen_end_point': (772.5, 399.0),
                 'screen_start_point': (772.5, 399.0),
                 'start_point': (772.5, 399.0),
                 'width': 5.0},
                {'end_point': (777.0, 399.0),
                 'number': 30,
                 'screen_end_point': (777.0, 399.0),
                 'screen_start_point': (777.0, 399.0),
                 'start_point': (777.0, 390.0),
                 'width': 14.0},
                {'end_point': (773.5, 718.0),
                 'number': 31,
                 'screen_end_point': (773.5, 718.0),
                 'screen_start_point': (773.5, 718.0),
                 'start_point': (773.5, 718.0),
                 'width': 3.0},
                {'end_point': (773.5, 723.0),
                 'number': 32,
                 'screen_end_point': (773.5, 723.0),
                 'screen_start_point': (773.5, 723.0),
                 'start_point': (773.5, 723.0),
                 'width': 3.0},
                {'end_point': (778.0, 723.0),
                 'number': 33,
                 'screen_end_point': (778.0, 723.0),
                 'screen_start_point': (778.0, 723.0),
                 'start_point': (778.0, 718.0),
                 'width': 12.0},
                {'end_point': (773.5, 777.0),
                 'number': 34,
                 'screen_end_point': (773.5, 777.0),
                 'screen_start_point': (773.5, 777.0),
                 'start_point': (773.5, 777.0),
                 'width': 3.0},
                {'end_point': (773.5, 781.0),
                 'number': 35,
                 'screen_end_point': (773.5, 781.0),
                 'screen_start_point': (773.5, 781.0),
                 'start_point': (773.5, 781.0),
                 'width': 3.0},
                {'end_point': (778.0, 777.0),
                 'number': 36,
                 'screen_end_point': (778.0, 777.0),
                 'screen_start_point': (778.0, 777.0),
                 'start_point': (778.0, 781.0),
                 'width': 12.0},
                {'end_point': (779.5, 399.0),
                 'number': 37,
                 'screen_end_point': (779.5, 399.0),
                 'screen_start_point': (779.5, 399.0),
                 'start_point': (779.5, 441.0),
                 'width': 9.0},
                {'end_point': (779.5, 640.0),
                 'number': 38,
                 'screen_end_point': (779.5, 640.0),
                 'screen_start_point': (779.5, 640.0),
                 'start_point': (779.5, 450.0),
                 'width': 9.0},
                {'end_point': (779.5, 718.0),
                 'number': 39,
                 'screen_end_point': (779.5, 718.0),
                 'screen_start_point': (779.5, 718.0),
                 'start_point': (779.5, 645.0),
                 'width': 9.0},
                {'end_point': (779.5, 741.0),
                 'number': 40,
                 'screen_end_point': (779.5, 741.0),
                 'screen_start_point': (779.5, 741.0),
                 'start_point': (779.5, 723.0),
                 'width': 9.0},
                {'end_point': (779.5, 759.0),
                 'number': 41,
                 'screen_end_point': (779.5, 759.0),
                 'screen_start_point': (779.5, 759.0),
                 'start_point': (779.5, 777.0),
                 'width': 9.0},
                {'end_point': (779.5, 882.0),
                 'number': 42,
                 'screen_end_point': (779.5, 882.0),
                 'screen_start_point': (779.5, 882.0),
                 'start_point': (779.5, 781.0),
                 'width': 9.0},
                {'end_point': (779.5, 972.0),
                 'number': 43,
                 'screen_end_point': (779.5, 972.0),
                 'screen_start_point': (779.5, 972.0),
                 'start_point': (779.5, 886.0),
                 'width': 9.0},
                {'end_point': (528.0, 541.5),
                 'number': 44,
                 'screen_end_point': (528.0, 541.5),
                 'screen_start_point': (528.0, 541.5),
                 'start_point': (337.0, 541.5),
                 'width': 9.0},
                {'end_point': (422.0, 976.5),
                 'number': 45,
                 'screen_end_point': (422.0, 976.5),
                 'screen_start_point': (422.0, 976.5),
                 'start_point': (337.0, 976.5),
                 'width': 9.0},
                {'end_point': (512.0, 825.5),
                 'number': 46,
                 'screen_end_point': (512.0, 825.5),
                 'screen_start_point': (512.0, 825.5),
                 'start_point': (337.0, 825.5),
                 'width': 5.0},
                {'end_point': (554.0, 878.0),
                 'number': 47,
                 'screen_end_point': (554.0, 878.0),
                 'screen_start_point': (554.0, 878.0),
                 'start_point': (517.0, 878.0),
                 'width': 4.0},
                {'end_point': (554.0, 976.5),
                 'number': 48,
                 'screen_end_point': (554.0, 976.5),
                 'screen_start_point': (554.0, 976.5),
                 'start_point': (518.0, 976.5),
                 'width': 9.0},
                {'end_point': (614.0, 541.5),
                 'number': 49,
                 'screen_end_point': (614.0, 541.5),
                 'screen_start_point': (614.0, 541.5),
                 'start_point': (588.0, 541.5),
                 'width': 9.0},
                {'end_point': (703.0, 825.5),
                 'number': 50,
                 'screen_end_point': (703.0, 825.5),
                 'screen_start_point': (703.0, 825.5),
                 'start_point': (601.0, 825.5),
                 'width': 5.0},
                {'end_point': (775.0, 976.5),
                 'number': 51,
                 'screen_end_point': (775.0, 976.5),
                 'screen_start_point': (775.0, 976.5),
                 'start_point': (601.0, 976.5),
                 'width': 9.0},
                {'end_point': (642.0, 445.5),
                 'number': 52,
                 'screen_end_point': (642.0, 445.5),
                 'screen_start_point': (642.0, 445.5),
                 'start_point': (619.0, 445.5),
                 'width': 9.0},
                {'end_point': (661.0, 445.5),
                 'number': 53,
                 'screen_end_point': (661.0, 445.5),
                 'screen_start_point': (661.0, 445.5),
                 'start_point': (646.0, 445.5),
                 'width': 9.0},
                {'end_point': (661.0, 445.5),
                 'number': 54,
                 'screen_end_point': (661.0, 445.5),
                 'screen_start_point': (661.0, 445.5),
                 'start_point': (661.0, 445.5),
                 'width': 9.0},
                {'end_point': (651.0, 394.5),
                 'number': 55,
                 'screen_end_point': (651.0, 394.5),
                 'screen_start_point': (651.0, 394.5),
                 'start_point': (646.0, 394.5),
                 'width': 9.0},
                {'end_point': (661.0, 445.5),
                 'number': 56,
                 'screen_end_point': (661.0, 445.5),
                 'screen_start_point': (661.0, 445.5),
                 'start_point': (661.0, 445.5),
                 'width': 9.0},
                {'end_point': (691.0, 445.5),
                 'number': 57,
                 'screen_end_point': (691.0, 445.5),
                 'screen_start_point': (691.0, 445.5),
                 'start_point': (661.0, 445.5),
                 'width': 9.0},
                {'end_point': (674.0, 642.5),
                 'number': 58,
                 'screen_end_point': (674.0, 642.5),
                 'screen_start_point': (674.0, 642.5),
                 'start_point': (661.0, 642.5),
                 'width': 5.0},
                {'end_point': (746.0, 720.5),
                 'number': 59,
                 'screen_end_point': (746.0, 720.5),
                 'screen_start_point': (746.0, 720.5),
                 'start_point': (679.0, 720.5),
                 'width': 5.0},
                {'end_point': (746.0, 732.0),
                 'number': 60,
                 'screen_end_point': (746.0, 732.0),
                 'screen_start_point': (746.0, 732.0),
                 'start_point': (746.0, 732.0),
                 'width': 18.0},
                {'end_point': (703.0, 779.0),
                 'number': 61,
                 'screen_end_point': (703.0, 779.0),
                 'screen_start_point': (703.0, 779.0),
                 'start_point': (674.0, 779.0),
                 'width': 4.0},
                {'end_point': (746.0, 779.0),
                 'number': 62,
                 'screen_end_point': (746.0, 779.0),
                 'screen_start_point': (746.0, 779.0),
                 'start_point': (707.0, 779.0),
                 'width': 4.0},
                {'end_point': (746.0, 770.5),
                 'number': 63,
                 'screen_end_point': (746.0, 770.5),
                 'screen_start_point': (746.0, 770.5),
                 'start_point': (746.0, 770.5),
                 'width': 13.0},
                {'end_point': (754.0, 720.5),
                 'number': 64,
                 'screen_end_point': (754.0, 720.5),
                 'screen_start_point': (754.0, 720.5),
                 'start_point': (751.0, 720.5),
                 'width': 5.0},
                {'end_point': (751.0, 772.5),
                 'number': 65,
                 'screen_end_point': (751.0, 772.5),
                 'screen_start_point': (751.0, 772.5),
                 'start_point': (746.0, 772.5),
                 'width': 17.0},
                {'end_point': (754.0, 779.0),
                 'number': 66,
                 'screen_end_point': (754.0, 779.0),
                 'screen_start_point': (754.0, 779.0),
                 'start_point': (751.0, 779.0),
                 'width': 4.0},
                {'end_point': (775.0, 642.5),
                 'number': 67,
                 'screen_end_point': (775.0, 642.5),
                 'screen_start_point': (775.0, 642.5),
                 'start_point': (709.0, 642.5),
                 'width': 5.0},
                {'end_point': (775.0, 445.5),
                 'number': 68,
                 'screen_end_point': (775.0, 445.5),
                 'screen_start_point': (775.0, 445.5),
                 'start_point': (733.0, 445.5),
                 'width': 9.0},
                {'end_point': (775.0, 884.0),
                 'number': 69,
                 'screen_end_point': (775.0, 884.0),
                 'screen_start_point': (775.0, 884.0),
                 'start_point': (737.0, 884.0),
                 'width': 4.0},
                {'end_point': (751.0, 770.5),
                 'number': 70,
                 'screen_end_point': (751.0, 770.5),
                 'screen_start_point': (751.0, 770.5),
                 'start_point': (751.0, 770.5),
                 'width': 13.0},
                {'end_point': (751.0, 732.0),
                 'number': 71,
                 'screen_end_point': (751.0, 732.0),
                 'screen_start_point': (751.0, 732.0),
                 'start_point': (751.0, 732.0),
                 'width': 18.0},
                {'end_point': (775.0, 394.5),
                 'number': 72,
                 'screen_end_point': (775.0, 394.5),
                 'screen_start_point': (775.0, 394.5),
                 'start_point': (770.0, 394.5),
                 'width': 9.0},
                {'end_point': (775.0, 720.5),
                 'number': 73,
                 'screen_end_point': (775.0, 720.5),
                 'screen_start_point': (775.0, 720.5),
                 'start_point': (772.0, 720.5),
                 'width': 5.0},
                {'end_point': (775.0, 732.0),
                 'number': 74,
                 'screen_end_point': (775.0, 732.0),
                 'screen_start_point': (775.0, 732.0),
                 'start_point': (775.0, 732.0),
                 'width': 18.0},
                {'end_point': (775.0, 779.0),
                 'number': 75,
                 'screen_end_point': (775.0, 779.0),
                 'screen_start_point': (775.0, 779.0),
                 'start_point': (772.0, 779.0),
                 'width': 4.0},
                {'end_point': (775.0, 768.0),
                 'number': 76,
                 'screen_end_point': (775.0, 768.0),
                 'screen_start_point': (775.0, 768.0),
                 'start_point': (775.0, 768.0),
                 'width': 18.0},
                {'end_point': (784.0, 750.0),
                 'number': 77,
                 'screen_end_point': (784.0, 750.0),
                 'screen_start_point': (784.0, 750.0),
                 'start_point': (775.0, 750.0),
                 'width': 18.0}]

try:
    with open('dxfFilesIn/identification_json/detect_wall.json') as identification_json_file:
        identification_json = json.load(identification_json_file)
        print('Success in reading the JSON file.')
except Exception:
    print('Failed to open identification JSON.')

windows = list(filter(lambda entity: entity['type']=='window', identification_json['entities']))
doors = list(filter(lambda entity: entity['type']=='door', identification_json['entities']))

print('windows:', len(windows))
pprint.pprint(windows)

print('doors:', len(doors))
pprint.pprint(doors)


def extend_wall_lines_for_entity(entity: dict, centre_lines: List["CentreLine"], graph: "nx.Graph"):
    """This function extends the wall_lines(edges) and updates the graph by the extending the walls for that entity.
    
    Procedure:
        1. Do some exception handling to check the type of the entity is "door" or "window".
        2. Get entity location:
            entity_location = entity["location"]
        3. Get nearest centre lines to that entity:
            nearest_centre_lines = get_nearest_lines_to_a_point(point = entity_location, lines = centre_lines)
        4. For the first two nearest lines, extend the wall:
            extended_lines = get_extended_wall_lines_with_nearest_lines(graph, nearest_line1, nearest_line2)

    Args:
        entity (dict: "Entity"): Either of type "door" or "wall".
        centre_lines (current centrelines): current centrelines generated from the graph.
        graph (nx.Graph): A networkx graph.
    """
    def get_extended_wall_lines_with_nearest_lines(
        graph: 'nx.Graph', nearest_line1: "CentreLine", nearest_line2: "CentreLine") -> List[tuple]:
        """This function extends the walls by taking in the input two nearest lines.
        
        Procedure:
            1. find rotations of both the lines:
                rotation1: nearest_line_1
                rotation2: nearest_line_2
            2. only rotations that can be accepted is (0 | 180) degree or (90 | 270) degree. [+- 1 degree acceptable]
            3. define left_end_point:
                left_end_point = closest_point(nearest_line) if rotation_1 == (0 | 180) else perpendicular_point(entity_location, nearest_line1)
            4. define right_end_point:
                right_end_point = closest_point(nearest_line) if rotation_1 == (0 | 180) else perpendicular_point(entity_location, nearest_line1)
            5. Now get points above the lines:
                left_end_points = directed_points(point, (rotation1 - 90), nearest_line1.width)
                right_end_points = directed_points(point, (rotation2 - 90), nearest_line2.width)
            6. return [(left_end_points[0], right_end_points[0]), (left_end_points[1], right_end_points[1])]

        Args:
            graph (nx.Graph)
            nearest_line1 ("CentreLine"): nearest_line[0]
            nearest_line2 ("CentreLine"): nearest_line[1]
        """

    # 1. Do some exception handling to check the type of the entity is "door" or "window".
    ENTITY_TYPES_FOR_WHICH_WALLS_SHOULD_BE_EXTENDED = ('door', 'window')
    if not entity['type'] in ENTITY_TYPES_FOR_WHICH_WALLS_SHOULD_BE_EXTENDED:
        raise ValueError(
            f'Only entities with types in {ENTITY_TYPES_FOR_WHICH_WALLS_SHOULD_BE_EXTENDED} can be extended.')